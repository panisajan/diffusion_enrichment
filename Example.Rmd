---
title: "Network diffusion and Neighborhood method for pathway enrichment analysis"
author: "PJ"
date: "2025-01-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
```

## 1. PPI network construction from STRINGdb

##### Loading Required Libraries #####
```{r echo=TRUE, warning=FALSE, message=FALSE}
library(STRINGdb)
library(igraph)
library(diffuStats)
library(gprofiler2)
```

##### Configuration #####
- Set the STRINGdb version to 12.0 (latest version)
- Specify the species as Homo sapiens (9606)
- Set the interaction confidence score threshold to 900 to include only high-confidence interactions
- Load all gene data to ensure a comprehensive analysis

```{r}
string_db <- STRINGdb$new(version = "12.0", species = 9606, score_threshold = 900)
all_genes <- string_db$get_proteins()
```

##### Retrieve Interactions #####
- Extract interaction data from STRINGdb
- Merge the interaction data with gene symbol annotations

```{r results='hide'}
data <- data.frame(gene = all_genes$preferred_name)
mapped_data <- string_db$map(data, "gene", removeUnmappedRows = FALSE)

interaction_network <- string_db$get_interactions(mapped_data$STRING_id)
interaction_network <- merge(interaction_network, all_genes, 
                             by.x = "from", by.y = "protein_external_id", all.x = TRUE)
interaction_network <- merge(interaction_network, all_genes, 
                             by.x = "to", by.y = "protein_external_id", all.x = TRUE, 
                             suffixes = c("_A", "_B"))
interaction_network <- interaction_network[, c("preferred_name_A", "preferred_name_B", "combined_score")]
colnames(interaction_network) <- c("Gene_A", "Gene_B", "Combined_Score")
head(interaction_network)
```

```{r echo=FALSE}
knitr::kable(head(interaction_network), format="html")  %>% kable_styling("striped", full_width = F)
```

##### Graph Construction #####
- Convert the interaction data into a graph structure
- Use the combined score as edge weights

```{r}
g <- graph_from_data_frame(d = interaction_network, directed = FALSE, vertices = NULL)
E(g)$weight <- interaction_network$Combined_Score
components <- igraph::clusters(g, mode="weak")
largest_cluster <- which.max(components$csize)
large_nodes <- V(g)[components$membership == largest_cluster]
g <- induced_subgraph(g, large_nodes)
is_connected(g)
```

## 2. Seed nodes Assignment and Expansion

##### Selecting Seed Nodes #####
- Seed nodes (Genes of interest) can come from any prior analysis in the gene symbol format
- For example, 
```{r}
seed_genes <- c("TP53", "BRCA1", "EGFR", "AKT1", "PIK3CA", 
                "MTOR", "PTEN", "CDK2", "KRAS", "BRAF")
```

#### **Neighborhood expansion** ####
Neighborhood method considers seed genes and seed genes' neighbors.
```{r}
neighbors_list <- unique(unlist(lapply(seed_genes, function(gene) {
  V(g)$name[neighbors(g, gene, mode = "all")]
})))
neighbors_list = unique(c(neighbors_list, seed_genes))
length(neighbors_list)
```

#### **Network Diffusion** ####
Network diffusion spreads values from the initial seed nodes across the network. The matrix 
$D$ represents the sum of each row in the adjacency matrix $A$, and the graph Laplacian is given by 
$𝐿=𝐷−𝑊$, where $W$ is the adjacency matrix. The Laplacian kernel is calculated as 
$𝐾=(𝐼+𝛼𝐿)^{−1}$, where $I$ is the identity matrix and $α$ is the diffusion rate, set to 1 in this study. The diffusion score is calculated as:

$$ Diffusion=K⋅y $$
where $𝑦$   is a vector with a value of 1 for nodes in seed nodes and 0 for others. Nodes that are more connected to the seed nodes will have higher diffusion scores, meaning they are more influenced by the seed group.

First, we use diffuStats package to compute regularize laplacian kernel ($K$).

```{r}
K <- regularisedLaplacianKernel(g,sigma2=1, add_diag=1,normalized=FALSE)
```

Next, the vector $y$ is computed to obtain diffusion score.

```{r}
y <- ifelse(V(g)$name %in% seed_genes, 1, 0)
F_dif <- K %*% y
F_dif <- data.frame(F_dif)
```
Note that the network diffusion method assigns a score to all genes in the network. We need to select the size of the top scores, for example, by choosing the 99th percentile. This means we consider the genes whose diffusion scores are in the top 1% of all scores, focusing on the most strongly influenced genes in the network.

```{r}
size = length(y)*0.01
F_dif$name = rownames(F_dif)
F_dif = F_dif[order(F_dif$F_dif, decreasing = TRUE), ]
F_dif_select = head(F_dif$name, size)
```

## 3. Pathway enrichment analysis

Pathway enrichment analysis is performed using the gprofiler2 package. Here, the analysis uses the results from the network diffusion scores, focusing on pathways from "GO:BP" (Gene Ontology Biological Processes), "KEGG" (Kyoto Encyclopedia of Genes and Genomes), "REAC" (Reactome), and "WP" (WikiPathways).

```{r results='hide'}
result <- gost(query = F_dif_select,
                 organism = "hsapiens",  
                 sources = c("GO:BP", "KEGG", "REAC", "WP"))
table <- result$result
head(table)
```

```{r echo=FALSE}
knitr::kable(head(table), format="html")  %>% kable_styling("striped", full_width = F)
```
